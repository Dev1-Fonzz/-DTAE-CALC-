<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Peperiksaan Malaysia</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS kekal sama seperti kod asal anda */
        /* Semua CSS yang anda sediakan dikekalkan */
        /* ... */
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <!-- Header dan semua elemen HTML kekal sama -->
        <!-- ... -->
    </div>

    <!-- Fullscreen Mode -->
    <div class="fullscreen-mode hidden" id="fullscreenMode">
        <!-- Kekal sama seperti kod asal -->
        <!-- ... -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // URL Google Apps Script
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvR2u9DMwsuynMQfGT4KG-WzPV-Dus-7dQpJzenvwvjsW5Ek41372HZ23_Ryzk8IcS/exec';
            
            // Semua variable dan fungsi yang ada dikekalkan
            // ... 
            
            // Fungsi baru untuk menyimpan data ke Google Apps Script
            async function saveToGoogleAppsScript(data) {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('Error saving to Google Apps Script:', error);
                    throw error;
                }
            }
            
            // Fungsi untuk mendapatkan data dari Google Apps Script
            async function loadFromGoogleAppsScript() {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error loading from Google Apps Script:', error);
                    throw error;
                }
            }
            
            // Modifikasi fungsi saveResult untuk menyimpan ke Google Apps Script
            async function saveResult() {
                const studentName = document.getElementById('studentName').value;
                const schoolName = document.getElementById('schoolName').value;
                const subject = document.getElementById('subject').value;
                const totalObtained = totalObtainedSpan.textContent;
                const totalFull = totalFullSpan.textContent;
                const grade = gradeSpan.textContent;
                const examType = examTypeSelect.value;
                const studentClass = classInput.value;
                const testName = document.getElementById('testName').value;
                const age = document.getElementById('age').value;
                
                // Validate required fields
                if (!studentName || !subject || grade === '-' || !age) {
                    alert('Sila isi semua maklumat wajib (Nama, Mata Pelajaran, Umur) dan kira markah sebelum menyimpan.');
                    return;
                }
                
                // Update display information
                displayNameSpan.textContent = studentName;
                displayClassSpan.textContent = studentClass;
                displayExamTypeSpan.textContent = examType;
                
                // Create result object
                const result = {
                    id: Date.now(),
                    studentName,
                    schoolName,
                    subject,
                    totalObtained,
                    totalFull,
                    grade,
                    examType,
                    studentClass,
                    testName,
                    age,
                    date: new Date().toLocaleDateString('ms-MY'),
                    timestamp: new Date().toISOString()
                };
                
                try {
                    // Save to Google Apps Script
                    const saveResponse = await saveToGoogleAppsScript(result);
                    
                    if (saveResponse && saveResponse.status === 'success') {
                        // Add to data array
                        resultsData.push(result);
                        
                        // Save current state for undo
                        saveState();
                        
                        // Update results table
                        updateResultsTable();
                        
                        // Update summary
                        updateSummary();
                        
                        // Save to localStorage
                        saveToLocalStorage();
                        
                        // Clear form after saving
                        clearForm();
                        
                        // Add to log
                        addToLog(`Keputusan disimpan: ${subject} - ${totalObtained}/${totalFull} - Gred: ${grade}`);
                        
                        alert('Keputusan berjaya disimpan ke Google Sheet!');
                    } else {
                        throw new Error('Failed to save to Google Sheet');
                    }
                } catch (error) {
                    console.error('Error saving to Google Apps Script:', error);
                    
                    // Fallback: Save to local storage only
                    resultsData.push(result);
                    saveState();
                    updateResultsTable();
                    updateSummary();
                    saveToLocalStorage();
                    clearForm();
                    addToLog(`Keputusan disimpan (Lokal sahaja): ${subject} - ${totalObtained}/${totalFull} - Gred: ${grade}`);
                    
                    alert('Keputusan disimpan secara lokal sahaja. Gagal menyambung ke Google Sheet.');
                }
            }
            
            // Modifikasi fungsi loadFromLocalStorage untuk cuba muat dari Google Apps Script
            async function loadFromLocalStorage() {
                try {
                    // Try to load from Google Apps Script first
                    const googleData = await loadFromGoogleAppsScript();
                    if (googleData && googleData.results) {
                        resultsData = googleData.results;
                        addToLog('Data dimuat dari Google Sheet');
                    } else {
                        // Fallback to localStorage
                        const savedData = localStorage.getItem('examResults');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            displayNameSpan.textContent = data.studentName || '-';
                            displayClassSpan.textContent = data.studentClass || '-';
                            displayExamTypeSpan.textContent = data.examType || '-';
                            resultsData = data.resultsData || [];
                            addToLog('Data dimuat dari penyimpanan lokal');
                        }
                    }
                } catch (error) {
                    console.error('Error loading from Google Apps Script, falling back to localStorage:', error);
                    
                    // Fallback to localStorage
                    const savedData = localStorage.getItem('examResults');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        displayNameSpan.textContent = data.studentName || '-';
                        displayClassSpan.textContent = data.studentClass || '-';
                        displayExamTypeSpan.textContent = data.examType || '-';
                        resultsData = data.resultsData || [];
                        addToLog('Data dimuat dari penyimpanan lokal (fallback)');
                    }
                    
                    addToLog('Gagal memuat data dari Google Sheet');
                }
                
                updateResultsTable();
                updateSummary();
            }
            
            // Fungsi untuk menyegerakkan data lokal ke Google Apps Script
            async function syncLocalDataToGoogle() {
                if (resultsData.length === 0) {
                    alert('Tiada data lokal untuk disegerakkan.');
                    return;
                }
                
                try {
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (const result of resultsData) {
                        try {
                            await saveToGoogleAppsScript(result);
                            successCount++;
                        } catch (error) {
                            console.error(`Gagal menyegerakkan data untuk ${result.subject}:`, error);
                            errorCount++;
                        }
                    }
                    
                    if (errorCount === 0) {
                        alert(`Semua data (${successCount} rekod) berjaya disegerakkan ke Google Sheet!`);
                        addToLog(`Data disegerakkan: ${successCount} rekod`);
                    } else {
                        alert(`${successCount} rekod berjaya disegerakkan, ${errorCount} rekod gagal.`);
                        addToLog(`Penyegerakkan separa: ${successCount} berjaya, ${errorCount} gagal`);
                    }
                } catch (error) {
                    console.error('Error syncing data to Google Apps Script:', error);
                    alert('Gagal menyegerakkan data ke Google Sheet.');
                    addToLog('Gagal menyegerakkan data ke Google Sheet');
                }
            }
            
            // Tambah butang untuk menyegerakkan data
            function addSyncButton() {
                const actionButtons = document.querySelector('.action-buttons');
                const syncButton = document.createElement('button');
                syncButton.className = 'btn-info';
                syncButton.id = 'syncBtn';
                syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Segerakkan ke Google Sheet';
                
                syncButton.addEventListener('click', syncLocalDataToGoogle);
                
                // Masukkan butang sebelum butang Muat Turun CSV
                actionButtons.insertBefore(syncButton, downloadBtn);
            }
            
            // Initialize app dengan fungsi baru
            function initializeApp() {
                setMode('guest');
                updateDateTime();
                loadFromLocalStorage();
                saveState();
                addSyncButton(); // Tambah butang sync
                
                // Update time every minute
                setInterval(updateDateTime, 60000);
            }
            
            // Event listeners - tambah event listener untuk saveBtn yang baru
            saveBtn.addEventListener('click', saveResult);
            
            // Semua event listeners lain kekal sama
            // ...
            
            // Initialize
            initializeApp();
        });
    </script>
</body>
</html>
